name: Publish to Crates.io

on:
  push:
    tags:
      - "v*"

env:
  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

jobs:
  publish-all:
    name: Publish Updated Crates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # å®šä¹‰å¹¶æ‰§è¡Œå‘å¸ƒé€»è¾‘
      # æˆ‘ä»¬å°†æ‰€æœ‰å‘å¸ƒæ­¥éª¤åˆå¹¶åœ¨ä¸€ä¸ª script ä¸­ï¼Œè¿™æ ·å‡½æ•°å®šä¹‰å¯ä»¥ç›´æ¥å¤ç”¨ï¼Œ
      # ä¸”ä¸éœ€è¦å¤æ‚çš„ç¯å¢ƒå˜é‡ä¼ é€’ã€‚
      - name: Auto Publish
        shell: bash
        run: |
          # --- å‡½æ•°å®šä¹‰ ---
          publish_crate() {
            local CRATE_PATH=$1
            local CRATE_NAME=$2

            # ç®€å•çš„ TOML ç‰ˆæœ¬è§£æï¼šæŸ¥æ‰¾ name = "..." ä¸‹æ–¹çš„ version = "..."
            # æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ Cargo.toml æ ¼å¼æ¯”è¾ƒæ ‡å‡†ã€‚
            local VERSION=$(grep "^version" "$CRATE_PATH/Cargo.toml" | head -n 1 | cut -d '"' -f 2)

            # å¦‚æœæ²¡æ‰¾åˆ°ç‰ˆæœ¬å·ï¼ˆæ¯”å¦‚ workspace ç»§æ‰¿ï¼‰ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ grep é€»è¾‘
            # è¿™é‡Œåšä¸ªç®€å•çš„é˜²å¾¡
            if [ -z "$VERSION" ]; then
                echo "âš ï¸  Could not detect version for $CRATE_NAME in $CRATE_PATH. Skipping auto-check."
                # è¿™ç§æƒ…å†µä¸‹å°è¯•å¼ºåˆ¶å‘å¸ƒï¼Œè®© cargo å†³å®š
                cargo publish -p "$CRATE_NAME" || true
                return
            fi

            echo "------------------------------------------------"
            echo "ğŸ“¦ Checking $CRATE_NAME (v$VERSION)..."

            # æ£€æŸ¥ crates.io API
            local HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://crates.io/api/v1/crates/$CRATE_NAME/$VERSION")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Version $VERSION already exists on crates.io. Skipping."
            else
              echo "ğŸš€ Version $VERSION not found. Publishing..."

              # æ‰§è¡Œå‘å¸ƒï¼Œå¦‚æœå¤±è´¥åˆ™é€€å‡ºè„šæœ¬ (set -e çš„æ•ˆæœï¼Œæˆ–è€…æ‰‹åŠ¨æ£€æŸ¥)
              cargo publish -p "$CRATE_NAME"

              echo "â³ Waiting for index propagation (20s)..."
              sleep 20
            fi
          }

          # --- ä¾èµ–é¡ºåºæ‰§è¡Œ (Topology Order) ---

          # 1. åŸºç¡€ä¾èµ–å±‚
          publish_crate "crates/vacro-doc-i18n" "vacro-doc-i18n"
          publish_crate "crates/vacro-parser" "vacro-parser"

          # 2. å®å®ç°å±‚ (Macro Impls)
          publish_crate "crates/vacro-report-macro" "vacro-report-macro"
          publish_crate "crates/vacro-trace-macro" "vacro-trace-macro"

          # 3. åŠŸèƒ½å°è£…å±‚ (Feature Wrappers)
          publish_crate "crates/vacro-report" "vacro-report"
          publish_crate "crates/vacro-trace" "vacro-trace"

          # 4. ä¸šåŠ¡é€»è¾‘å±‚ (Analysis)
          publish_crate "crates/vacro-analysis" "vacro-analysis"

          # 5. åº”ç”¨å±‚ (CLI & Root)
          publish_crate "crates/vacro-cli" "vacro-cli"
          publish_crate "." "vacro"

          echo "All crates checked and published!"
