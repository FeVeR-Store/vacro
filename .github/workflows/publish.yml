name: Publish to Crates.io

on:
  push:
    tags:
      - "v*"

env:
  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

jobs:
  publish-all:
    name: Publish Updated Crates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # å®šä¹‰å¹¶æ‰§è¡Œå‘å¸ƒé€»è¾‘
      # æˆ‘ä»¬å°†æ‰€æœ‰å‘å¸ƒæ­¥éª¤åˆå¹¶åœ¨ä¸€ä¸ª script ä¸­ï¼Œè¿™æ ·å‡½æ•°å®šä¹‰å¯ä»¥ç›´æ¥å¤ç”¨ï¼Œ
      # ä¸”ä¸éœ€è¦å¤æ‚çš„ç¯å¢ƒå˜é‡ä¼ é€’ã€‚
      - name: Auto Publish
        shell: bash
        run: |
          # --- å‡½æ•°å®šä¹‰ ---
          publish_crate() {
             local CRATE_PATH=$1
             local CRATE_NAME=$2

             # è·å–ç‰ˆæœ¬å·
             local VERSION=$(grep "^version" "$CRATE_PATH/Cargo.toml" | head -n 1 | cut -d '"' -f 2)

             if [ -z "$VERSION" ]; then
                 echo "âš ï¸  Could not detect version for $CRATE_NAME. Skipping check."
                 cargo publish -p "$CRATE_NAME" || true
                 return
             fi

             echo "------------------------------------------------"
             echo "ğŸ“¦ Checking $CRATE_NAME (v$VERSION)..."

             # --- å…³é”®ä¿®æ”¹ç‚¹ ---
             # 1. æ·»åŠ  -A "vacro-ci" æŒ‡å®š User-Agentï¼Œé˜²æ­¢è¢« Crates.io æ‹¦æˆª (403é”™è¯¯)
             # 2. æ·»åŠ  -L è·Ÿéšé‡å®šå‘
             local HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L -A "vacro-ci" "https://crates.io/api/v1/crates/$CRATE_NAME/$VERSION")

             echo "   -> API returned HTTP $HTTP_CODE"

             if [ "$HTTP_CODE" = "200" ]; then
                 echo "âœ… Version $VERSION already exists on crates.io. Skipping."
                 return 0
             elif [ "$HTTP_CODE" = "404" ] || [ "$HTTP_CODE" = "000" ]; then
                 # 404 è¡¨ç¤ºç¡®å®æ²¡æ‰¾åˆ°ï¼Œ000 è¡¨ç¤º curl è¿ä¸ä¸Š(å¯èƒ½ç½‘ç»œé—®é¢˜ï¼Œä½†ä¹Ÿå°è¯•å‘å¸ƒ)
                 echo "ğŸš€ Version $VERSION not found (HTTP $HTTP_CODE). Publishing..."

                 # æ‰§è¡Œå‘å¸ƒ
                 cargo publish -p "$CRATE_NAME"

                 echo "â³ Waiting for index propagation (20s)..."
                 sleep 20
             else
                 # å¤„ç†å…¶ä»–å¼‚å¸¸çŠ¶æ€ (å¦‚ 403, 500 ç­‰)
                 echo "âš ï¸  API check failed with HTTP $HTTP_CODE. Assuming already exists or temporary error."
                 echo "   To be safe, we will try to publish but allow failure."

                 # å°è¯•å‘å¸ƒï¼Œå¦‚æœæ˜¯å› ä¸ºâ€œå·²å­˜åœ¨â€æŠ¥é”™ï¼Œæˆ‘ä»¬å¿½ç•¥å®ƒ
                 # è¿™é‡Œçš„ || true ç¨å¾®æœ‰ç‚¹æš´åŠ›ï¼Œä½†å¯¹äº CI è¿™ç§åœºæ™¯ï¼Œ
                 # å¦‚æœæ˜¯å› ä¸ºç‰ˆæœ¬å·²å­˜åœ¨å¯¼è‡´çš„æŠ¥é”™ï¼Œå¿½ç•¥å®ƒæ˜¯æœ€ç®€å•çš„åŠæ³•ã€‚
                 # å¦‚æœä½ æƒ³æ›´ä¸¥è°¨ï¼Œå¯ä»¥æ•è·è¾“å‡ºåˆ¤æ–­é”™è¯¯ä¿¡æ¯ã€‚
                 cargo publish -p "$CRATE_NAME" || echo "âš ï¸ Publish failed, possibly already exists. Continuing..."
             fi
           }

          # --- ä¾èµ–é¡ºåºæ‰§è¡Œ (Topology Order) ---

          # 1. åŸºç¡€ä¾èµ–å±‚
          publish_crate "crates/vacro-doc-i18n" "vacro-doc-i18n"

          # 2. å®å®ç°å±‚ (Macro Impls)
          publish_crate "crates/vacro-parser" "vacro-parser"
          publish_crate "crates/vacro-report-macro" "vacro-report-macro"
          publish_crate "crates/vacro-trace-macro" "vacro-trace-macro"

          # 3. åŠŸèƒ½å°è£…å±‚ (Feature Wrappers)
          publish_crate "crates/vacro-report" "vacro-report"
          publish_crate "crates/vacro-trace" "vacro-trace"

          # 4. ä¸šåŠ¡é€»è¾‘å±‚ (Analysis)
          publish_crate "crates/vacro-analysis" "vacro-analysis"

          # 5. åº”ç”¨å±‚ (CLI & Root)
          publish_crate "crates/vacro-cli" "vacro-cli"
          publish_crate "." "vacro"

          echo "All crates checked and published!"
