name: Publish to Crates.io

on:
  push:
    tags:
      - "v*"

env:
  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

jobs:
  publish-all:
    name: Publish Updated Crates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # å®šä¹‰å¹¶æ‰§è¡Œå‘å¸ƒé€»è¾‘
      # æˆ‘ä»¬å°†æ‰€æœ‰å‘å¸ƒæ­¥éª¤åˆå¹¶åœ¨ä¸€ä¸ª script ä¸­ï¼Œè¿™æ ·å‡½æ•°å®šä¹‰å¯ä»¥ç›´æ¥å¤ç”¨ï¼Œ
      # ä¸”ä¸éœ€è¦å¤æ‚çš„ç¯å¢ƒå˜é‡ä¼ é€’ã€‚
      - name: Auto Publish
        shell: bash
        run: |
          # --- å‡½æ•°å®šä¹‰ ---
          publish_crate() {
              local CRATE_PATH=$1
              local CRATE_NAME=$2
              local MAX_RETRIES=3  # æœ€å¤§é‡è¯•æ¬¡æ•°
              local RETRY_DELAY=60 # æ¯æ¬¡é‡è¯•ç­‰å¾…ç§’æ•° (é‡åˆ°429é€šå¸¸éœ€è¦ç­‰ä¹…ä¸€ç‚¹)

              # 1. è·å–ç‰ˆæœ¬å·
              local VERSION=$(grep "^version" "$CRATE_PATH/Cargo.toml" | head -n 1 | cut -d '"' -f 2)

              if [ -z "$VERSION" ]; then
                  echo "âš ï¸  Version not detected for $CRATE_NAME. Skipping check."
                  return
              fi

              echo "------------------------------------------------"
              echo "ğŸ” Checking $CRATE_NAME (v$VERSION) on crates.io..."

              # 2. API æ£€æŸ¥ (å¸¦ User-Agent)
              local HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L -A "vacro-ci-bot" "https://crates.io/api/v1/crates/$CRATE_NAME/$VERSION")

              if [ "$HTTP_CODE" = "200" ]; then
                  echo "âœ… Version $VERSION already exists. Skipping."
                  return 0
              fi

              echo "ğŸ“„ Preparing documentation for $CRATE_NAME..."
              # å°†æ ¹ç›®å½•çš„ HTML å¤åˆ¶åˆ°å½“å‰ crate ç›®å½•ä¸‹
              # æ³¨æ„ï¼šå‡è®¾è„šæœ¬æ˜¯åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼Œ$CRATE_PATH æ˜¯ç›¸å¯¹è·¯å¾„
              cp "docs/doc-i18n.html" "$CRATE_PATH/doc-i18n.html"

              # 3. å‡†å¤‡å‘å¸ƒ (å¤„ç† 404 æˆ–å…¶ä»–æƒ…å†µ)
              echo "ğŸš€ Version $VERSION needs to be published (HTTP $HTTP_CODE)."

              # --- é‡è¯•é€»è¾‘ ---
              for (( i=1; i<=MAX_RETRIES; i++ )); do
                  echo "   [Attempt $i/$MAX_RETRIES] Publishing $CRATE_NAME..."

                  # å°è¯•å‘å¸ƒ
                  # set +e ä¸´æ—¶å…è®¸å¤±è´¥ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ•è·é”™è¯¯è€Œä¸æ˜¯è®©è„šæœ¬ç›´æ¥é€€å‡º
                  set +e
                  cargo publish -p "$CRATE_NAME" --allow-dirty
                  local EXIT_CODE=$?
                  set -e # æ¢å¤é‡åˆ°é”™è¯¯å³é€€å‡º

                  if [ $EXIT_CODE -eq 0 ]; then
                      echo "âœ… Successfully published $CRATE_NAME v$VERSION"
                      echo "â³ Waiting 20s for index propagation..."
                      sleep 20
                      return 0
                  else
                      echo "âš ï¸  Publish failed with exit code $EXIT_CODE."
                      if [ $i -lt $MAX_RETRIES ]; then
                          echo "â³ Likely rate limited (429). Sleeping for ${RETRY_DELAY}s before retrying..."
                          sleep $RETRY_DELAY
                          # æ¯æ¬¡é‡è¯•å¢åŠ å»¶è¿Ÿæ—¶é—´ (ç®€å•çš„é€€é¿ç­–ç•¥)
                          RETRY_DELAY=$((RETRY_DELAY + 60))
                      else
                          echo "âŒ Exhausted all retries. Failing."
                          return 1
                      fi
                  fi
              done

              # æ¸…ç†
              rm "$CRATE_PATH/doc-i18n.html"
          }

          # --- ä¾èµ–é¡ºåºæ‰§è¡Œ (Topology Order) ---

          # 1. åŸºç¡€ä¾èµ–å±‚
          publish_crate "crates/vacro-doc-i18n" "vacro-doc-i18n"

          # 2. å®å®ç°å±‚ (Macro Impls)
          publish_crate "crates/vacro-parser" "vacro-parser"
          publish_crate "crates/vacro-report-macro" "vacro-report-macro"
          publish_crate "crates/vacro-trace-macro" "vacro-trace-macro"

          # 3. åŠŸèƒ½å°è£…å±‚ (Feature Wrappers)
          publish_crate "crates/vacro-report" "vacro-report"
          publish_crate "crates/vacro-trace" "vacro-trace"

          # 4. ä¸šåŠ¡é€»è¾‘å±‚ (Analysis)
          publish_crate "crates/vacro-analysis" "vacro-analysis"

          # 5. åº”ç”¨å±‚ (CLI & Root)
          publish_crate "crates/vacro-cli" "vacro-cli"
          publish_crate "." "vacro"

          echo "All crates checked and published!"
