name: Publish to Crates.io

on:
  push:
    tags:
      - "v*"

env:
  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

jobs:
  publish:
    name: Publish Updated Crates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # è¿™ä¸€æ­¥å®šä¹‰äº†ä¸€ä¸ª bash å‡½æ•°ï¼Œç”¨æ¥æ£€æŸ¥ç‰ˆæœ¬å¹¶å‘å¸ƒ
      # é€»è¾‘ï¼š
      # 1. è¯»å– Cargo.toml é‡Œçš„ç‰ˆæœ¬å·
      # 2. ç”¨ curl é—® crates.io è¿™ä¸ªç‰ˆæœ¬æœ‰äº†å—ï¼Ÿ
      # 3. æœ‰äº† -> è·³è¿‡
      # 4. æ²¡æœ‰ -> cargo publish
      - name: Define Publish Logic
        id: publish_func
        run: |
          echo 'publish_crate() {
            CRATE_PATH=$1
            CRATE_NAME=$2

            VERSION=$(grep "^version" $CRATE_PATH/Cargo.toml | head -n 1 | cut -d '"' -f 2)

            echo "------------------------------------------------"
            echo "Checking $CRATE_NAME (v$VERSION)..."

            # æ£€æŸ¥ crates.io API (è¿”å› 200 è¡¨ç¤ºå­˜åœ¨ï¼Œ404 è¡¨ç¤ºä¸å­˜åœ¨)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://crates.io/api/v1/crates/$CRATE_NAME/$VERSION)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Version $VERSION already exists on crates.io. Skipping."
            else
              echo "ğŸš€ Version $VERSION not found. Publishing..."
              cargo publish -p $CRATE_NAME

              # å‘å¸ƒåä¼‘çœ ä¸€ä¼šï¼Œç­‰å¾…ç´¢å¼•æ›´æ–°ï¼Œé˜²æ­¢ä¾èµ–å®ƒçš„åŒ…æ‰¾ä¸åˆ°ç‰ˆæœ¬
              echo "â³ Waiting for index propagation..."
              sleep 20
            fi
          }' >> $GITHUB_ENV

      # ä¸‹é¢æŒ‰ç…§ä¾èµ–é¡ºåºï¼Œä¾æ¬¡è°ƒç”¨ä¸Šé¢çš„é€»è¾‘

      # 1. æœ€åº•å±‚åº“ (æ— ä¾èµ–)
      - name: Process vacro-doc-i18n
        run: |
          source $GITHUB_ENV
          publish_crate "crates/vacro-doc-i18n" "vacro-doc-i18n"

      - name: Process vacro-report
        run: |
          source $GITHUB_ENV
          publish_crate "crates/vacro-report" "vacro-report"

      # 2. æ ¸å¿ƒåº“
      - name: Process vacro-parser
        run: |
          source $GITHUB_ENV
          publish_crate "crates/vacro-parser" "vacro-parser"

      # 3. é—¨é¢åº“ (ä¾èµ–ä»¥ä¸Šæ‰€æœ‰)
      - name: Process vacro
        run: |
          source $GITHUB_ENV
          publish_crate "." "vacro"
